/**\n * ✅ ARCHIVO CORREGIDO: supabase/migrations/0003_fix_rls_policies.sql\n * \n * Este archivo CORRIGE las RLS policies que estaban demasiado permisivas.\n * Ejecutar en Supabase SQL Editor después de las migraciones 0001 y 0002.\n * \n * CAMBIOS:\n * - Remover política \"Public profiles are viewable by everyone\"\n * - Agregar política granular para usuarios\n * - Agregar política para ver perfiles de expertos activos\n */\n\n-- ============================================================================\n-- FIX: RLS POLICIES PARA TABLA PROFILES\n-- ============================================================================\n\n-- Verificar políticas actuales\nSELECT policy_name, qual\nFROM pg_policies\nWHERE tablename = 'profiles'\nORDER BY policy_name;\n\n-- ============================================================================\n-- PASO 1: REMOVER POLÍTICA PERMISIVA\n-- ============================================================================\n\nDROP POLICY IF EXISTS \"Public profiles are viewable by everyone\" ON profiles;\n\n-- ============================================================================\n-- PASO 2: AGREGAR NUEVA POLÍTICA - Usuarios ven su propio perfil\n-- ============================================================================\n\nCREATE POLICY \"Users can view own profile\"\n  ON profiles\n  FOR SELECT\n  USING (\n    auth.uid() = id\n  );\n\n-- ============================================================================\n-- PASO 3: AGREGAR POLÍTICA - Admins ven todos los perfiles\n-- ============================================================================\n\nCREATE POLICY \"Admins can view all profiles\"\n  ON profiles\n  FOR SELECT\n  USING (\n    (\n      SELECT role \n      FROM profiles \n      WHERE id = auth.uid()\n    ) = 'admin'\n  );\n\n-- ============================================================================\n-- PASO 4: AGREGAR POLÍTICA - Ver perfiles de expertos activos (datos públicos)\n-- ============================================================================\n\nCREATE POLICY \"Public can view active expert profiles\"\n  ON profiles\n  FOR SELECT\n  USING (\n    id IN (\n      SELECT user_id \n      FROM experts \n      WHERE status = 'active'\n    )\n  );\n\n-- ============================================================================\n-- PASO 5: UPDATE POLICY - Usuarios pueden actualizar su propio perfil\n-- ============================================================================\n\nCREATE POLICY \"Users can update own profile\"\n  ON profiles\n  FOR UPDATE\n  USING (\n    auth.uid() = id\n  )\n  WITH CHECK (\n    auth.uid() = id\n  );\n\n-- ============================================================================\n-- PASO 6: INSERT POLICY - Solo durante signup (trigger)\n-- ============================================================================\n\nCREATE POLICY \"Users can create own profile on signup\"\n  ON profiles\n  FOR INSERT\n  WITH CHECK (\n    auth.uid() = id\n  );\n\n-- ============================================================================\n-- VERIFICACIÓN\n-- ============================================================================\n\n-- Verificar que las nuevas políticas existen\nSELECT \n  policy_name,\n  qual,\n  with_check\nFROM pg_policies\nWHERE tablename = 'profiles'\nORDER BY policy_name;\n\n-- IMPORTANT: Después de ejecutar este script:\n-- 1. Logout de tu sesión actual\n-- 2. Login nuevamente\n-- 3. Verificar que solo ves tu propio perfil\n